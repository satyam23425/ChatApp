<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chat APP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg: #f1f4f9;
      --panel: #fff;
      --primary: #4a6cf7;
      --muted: #9aa4c1;
      --msg-other: #eef1f6;
      --msg-self: #4a6cf7;
      --text: #1f2937;
      --radius: 14px;
    }
    [data-theme="dark"] {
      --bg: #0f1724;
      --panel: #0b1220;
      --primary: #5b8aff;
      --muted: #8b98b2;
      --msg-other: #0f1726;
      --msg-self: #2b56d6;
      --text: #e6eefc;
    }

    *{box-sizing:border-box}
    html,body{height:100%;width:100%;margin:0;background:var(--bg);font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system;}
    .app {
      width: 100%;
      max-width: 1100px;
      height: calc(100vh - 40px);
      margin: 20px auto;
      display: flex;
      border-radius: 16px;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      box-shadow: 0 8px 30px rgba(16,24,40,0.08);
    }

    .left {
      width: 280px;
      background: var(--panel);
      padding: 20px;
      display:flex;flex-direction:column;gap:14px;
      border-right:1px solid rgba(0,0,0,0.04);
    }

    .brand {display:flex;align-items:center;gap:10px;font-weight:700;color:var(--primary);font-size:18px}
    .brand .logo {
      width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#3560d2);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    }

    .search input{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);
      background:transparent;color:var(--text);
    }

    .usersList {margin-top:10px;overflow:auto;display:flex;flex-direction:column;gap:10px}

    .user {display:flex;gap:12px;padding:10px;border-radius:12px;cursor:pointer;
      border:1px solid rgba(0,0,0,0.06);background:var(--panel);}
    .avatar {
      width:44px;height:44px;border-radius:12px;background:var(--primary);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    }

    .right {flex:1;display:flex;flex-direction:column;background:var(--panel)}

    .header {height:70px;background:var(--primary);color:white;display:flex;align-items:center;
      justify-content:space-between;padding:0 20px;font-weight:700;}

    .chatArea {flex:1;overflow:auto;padding:20px;}
    .messages {display:flex;flex-direction:column;gap:12px}

    .msg {max-width:70%;padding:12px 16px;border-radius:14px;font-size:15px}
    .msg.self {align-self:flex-end;background:var(--msg-self);color:white}
    .msg.other {align-self:flex-start;background:var(--msg-other);color:var(--text)}

    .msg .meta {font-size:12px;color:var(--muted);margin-bottom:6px}

    .footer {display:flex;gap:10px;padding:12px;background:var(--panel);
      border-top:1px solid rgba(0,0,0,0.06);}
    .footer input{
      flex:1;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);
      background:transparent;color:var(--text)
    }
    .btn {padding:10px 16px;border:none;border-radius:12px;background:var(--primary);color:white;font-weight:700;cursor:pointer}
    .small {padding:8px 12px;background:transparent;border-radius:10px;border:1px solid rgba(0,0,0,0.06);cursor:pointer}

    .typing {padding:0 20px;color:var(--muted);height:20px;font-size:14px}
  </style>
</head>

<body>

<div class="app">
  <div class="left">
    <div class="brand"><div class="logo">C</div>Chat Modern</div>

    <div class="search"><input placeholder="Search..." /></div>

    <div class="usersList" id="usersList"></div>
  </div>

  <div class="right">

    <div class="header">
      <div>ðŸ’¬ Chat Room</div>
      <div id="currentUser"></div>
    </div>

    <div class="chatArea" id="chatArea">
      <div class="messages" id="messages"></div>
    </div>

    <div class="typing" id="typing"></div>

    <div class="footer">
      <input id="messageInput" placeholder="Write a message..." />
      <button id="sendBtn" class="btn">Send</button>
      <button id="dmBtn" class="small">DM</button>
    </div>

  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

  // Connect automatically to local OR Ngrok
  const socket = io(window.location.origin);

  // Ask for username
  let username = "";
  while (!username) username = prompt("Choose username:")?.trim();
  document.getElementById("currentUser").textContent = username;

  socket.emit("register", username);

  const usersListEl = document.getElementById("usersList");
  const messagesEl = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const typingEl = document.getElementById("typing");
  const chatArea = document.getElementById("chatArea");

  // Display online users
  socket.on("onlineUsers", (users) => {
    usersListEl.innerHTML = "";

    users.filter(u => u !== username).forEach(u => {
      const div = document.createElement("div");
      div.className = "user";
      div.innerHTML = `
        <div class="avatar">${u.slice(0,2).toUpperCase()}</div>
        <div class="meta"><div class="name">${u}</div><div class="desc">Online</div></div>
      `;
      div.onclick = () => sendDM(u);
      usersListEl.appendChild(div);
    });
  });

  // Add message to chat
  function addMessage({from, message, self=false, privateMsg=false}) {
    const div = document.createElement("div");
    div.className = "msg " + (self ? "self" : "other");

    div.innerHTML = `
      <div class="meta">${self ? "You" : from}${privateMsg ? " (private)" : ""}</div>
      <div>${message}</div>
    `;

    messagesEl.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  // Send public message
  document.getElementById("sendBtn").onclick = () => {
    const msg = messageInput.value.trim();
    if (!msg) return;

    addMessage({from: username, message: msg, self: true});
    socket.emit("chatMessage", {from: username, message: msg});

    messageInput.value = "";
  };

  // Receive public message
  socket.on("chatMessage", data => {
    if (data.from !== username) addMessage(data);
  });

  // Typing indicator
  messageInput.oninput = () => {
    socket.emit("typing", {from: username, isTyping: true});
    clearTimeout(window._t);
    window._t = setTimeout(() => {
      socket.emit("typing", {from: username, isTyping: false});
    }, 800);
  };

  socket.on("typing", ({from, isTyping}) => {
    if (from === username) return;
    typingEl.textContent = isTyping ? `${from} is typing...` : "";
  });

  // Direct message
  function sendDM(toUser) {
    const msg = prompt(`DM to ${toUser}:`);
    if (!msg) return;

    addMessage({from: username, message: msg, self: true, privateMsg:true});
    socket.emit("privateMessage", {to: toUser, from: username, message: msg});
  }

  socket.on("privateMessage", (data) => {
    addMessage({from: data.from, message: data.message, privateMsg:true});
  });

</script>

</body>
</html>
